<Workflow name="Qmasters ObserveIT" version="1.0" xmlns="http://qradar.ibm.com/UniversalCloudRESTAPI/Workflow/V2">
    <Parameters>
		<Parameter name="identifier" label="Log Source Identifier" required="true" description="The log source identifier to post the events to." />
		<Parameter name="hostname" label="Host Name" required="true" description="URL or IP for the instance." default="https://myObserveIT.com" />
		<Parameter name="client_id" label="Organization Key" required="true" secret="true" description="Can be received through the Developer Portal by selecting Credentials and pressing the Create App button." />
		<Parameter name="client_secret" label="API Secret" required="true" secret="true" description="Can be received through the Developer Portal by selecting Credentials and pressing the Create App button." />

        <Parameter name="time_zone" label="Time Zone" description="The timezone used in ObserveIT." default="UTC" />
        <Parameter name="events_per_poll" label="Events Per Poll" description="Max number of records to return per poll.  Note: a large fetch may cause timeout errors." default="100" />
        <Parameter name="initial_event_fetch_period" label="Initial Event Fetch Period in Days" description="Number of days in the past from which events will be initially retrieved." default="7" />
        <Parameter name="report_type" label="Report Type" required="true" description="The report type to poll. One of: `alert_v0`,`audit_configuration_v0`,`audit_logins_v0`,`audit_saved_sessions_v0`,`audit_session_playback_v0`,`system_events_v0`,`user_command_activity_with_output_v0`,`user_command_output_stream_v0`,`user_dba_activity_v0`,`user_file_activity_v0`,`user_interface_activity_v0`,`user_messaging_actions_activity_v0`,`user_session_v0`." />
        <Parameter name="piis_to_exclude" label="Personal Identifiable Information to Exclude" description="Comma-separated list of Personal Identifiable Information (PII) to exclude." default="loginName,secondaryLoginName,endpointName,remoteHostName,windowTitle,accessedUrl,domainName,secondaryDomainName,remoteAddress,sqlUserName,sessionServerName,sessionLoginName,savedSessionName,operatorUsername,operatorDomainName,userName,machineName" />
    </Parameters>

    <Actions>
		<!-- Clear the log source status before a new workflow run starts. -->
        <ClearStatus />
        <Log type="INFO" message="[ObserveIT]: Authenticating, fetching bearer token..." />

		<!-- Get Bearer Token. -->
		<CallEndpoint url="${/hostname}/v2/apis/auth/oauth/token" method="POST" savePath="/response" >
            <!-- <SSLConfiguration allowUntrustedServerCertificate="true" /> -->
			<UrlEncodedFormRequestBody>
                <Parameter name="grant_type" value="client_credentials" />
                <Parameter name="client_id" value="${/client_id}" />
                <Parameter name="client_secret" value="${/client_secret}" />
                <Parameter name="scope" value="*" />
            </UrlEncodedFormRequestBody>
		</CallEndpoint>

		<!-- Handle errors. -->
        <If condition="/response/status_code != 200">
            <If condition="/response/status_code = 400">
                <Log type="ERROR" message="[ObserveIT]: Abort at get token, reason: ${/response/body/_status/message}" />
                <Abort reason="${/response}" />
            </If>
            <If condition="/response/status_code = 401">
                <Log type="ERROR" message="[ObserveIT]: Abort at get token, reason: Authentication error!" />
                <Abort reason="${/response}" />
            </If>
            <If condition="/response/status_code = 404">
                <Log type="ERROR" message="[ObserveIT]: Abort at get token, reason: URL not found!" />
                <Abort reason="${/response}" />
            </If>
            <If condition="/response/status_code = 408">
                <Log type="ERROR" message="[ObserveIT]: Abort at get token, reason: Timeout error!" />
                <Abort reason="${/response}" />
            </If>
            <If condition="/response/status_code = 500">
                <Log type="ERROR" message="[ObserveIT]: Abort at get token, reason: Invalid client_id" />
                <Abort reason="${/response}" />
            </If>

			<Log type="ERROR" message="[ObserveIT]: Abort at get token, reason: ${/response}" />
            <Abort reason="${/response}" />
        </If>

        <Log type="INFO" message="[ObserveIT]: Bearer token received!" />
        <!-- Save the bearer token. -->
		<Set path="/bearer_token" value="${/response/body/access_token}" />

        <!-- Incase the user has set all poll parameters to false. -->
        <If condition="count(/report_type) = 0">
            <Log type="ERROR" message="[ObserveIT]: Abort reason: Please choose a report type to poll." />
            <Abort reason="${/report_type}" />
        </If>

        <Log type="INFO" message="[ObserveIT]: The following report type will be fetched: ${/report_type}." />


        <!-- Initialize the risingValue filter for the first run. -->
        <Initialize path="/bookmark" value="${time() - /initial_event_fetch_period * 86400 * 1000}" />
        <Log type="INFO" message="[ObserveIT]: 'risingValue' time for '${/report_type}' to be fetched is: ${/bookmark}" />

        <Split value="${/piis_to_exclude}" delimiter="," savePath="/piis_to_exclude" />

        <!-- Handle PII. -->
        <If condition="count(/piis_to_exclude) > 0">
            <!-- Create a list of PIIs to exclude. -->
            <Log type="INFO" message="[ObserveIT]: Fetching fields for the report type '${/report_type}'..." />

            <!-- Get a report type fields. -->
            <CallEndpoint url="${/hostname}/v2/apis/report;realm=ObserveIT/reports/${/report_type}" method="GET" savePath="/response" >
                <!-- <SSLConfiguration allowUntrustedServerCertificate="true" /> -->
                <BearerAuthentication token="${/bearer_token}" />
            </CallEndpoint>

            <!-- Handle errors. -->
            <If condition="/response/status_code != 200">
                <If condition="/response/status_code = 401">
                    <Log type="ERROR" message="[ObserveIT]: Abort at get ${/report_type} report fields, reason: Authentication error!" />
                    <Abort reason="${/response}" />
                </If>
                <If condition="/response/status_code = 404">
                    <Log type="ERROR" message="[ObserveIT]: Abort at get ${/report_type} report fields, reason: URL not found!" />
                    <Abort reason="${/response}" />
                </If>
                <If condition="/response/status_code = 408">
                    <Log type="ERROR" message="[ObserveIT]: Abort at get ${/report_type} report fields, reason: Timeout error!" />
                    <Abort reason="${/response}" />
                </If>

                <Log type="ERROR" message="[ObserveIT]: Abort at get ${/report_type} report fields, reason: ${/response}" />
                <Abort reason="${/response}" />
            </If>


            <!-- Create an empty string that will hold the fields to fetch. -->
            <Set path="/fields" value="" />

            <!-- Create a list with all fields except for PII. -->
            <ForEach item="/column" items="/response/body/data[0]/columns">
                <Set path="/is_pii" value="false" />

                <!-- Check if the current field is a PII. -->
                <ForEach item="/pii_to_exclude" items="/piis_to_exclude">
                    <If condition="'${/column/name}' = '${/pii_to_exclude}'">
                        <Set path="/is_pii" value="true" />
                    </If>
                </ForEach>

                <!-- If the current field isn't a PII, save it in the include list. -->
                <If condition="${/is_pii} = false">
                    <If condition="${count(/fields) = 0}">
                        <Set path="/fields" value="${/column/name}" />
                    </If>
                    <Else>
                        <Set path="/fields" value="${/fields},${/column/name}" />
                    </Else>
                </If>
            </ForEach>
        </If>

        <Log type="INFO" message="[ObserveIT]: The following fields will be fetched for the report type '${/report_type}': ${/fields}." />
        <Log type="INFO" message="[ObserveIT]: Starting to fetch events through pagination for '${/report_type}'." />

        <Set path="/fetch_counter" value="1" />
        <Set path="/events_count" value="0" />
        <Set path="/sleep_time" value="20000"/>
        <Set path="/sleep_time_in_seconds" value="${/sleep_time / 1000}"/>
        <Initialize path="/time_format" value="yyyy-MM-dd'T'HH:mm:ss[.SSS]'Z'" />


        <!-- Pagination handling: aslong as events are returned, keep fetching data. -->
        <While condition="true">
            <Set path="/start_time" value="${time()}" />
            <Log type="INFO" message="[ObserveIT]: Running fetch number ${/fetch_counter} for '${/report_type}'..." />

            <!-- Get the reports. -->
            <CallEndpoint url="${/hostname}/v2/apis/report;realm=ObserveIT/reports/${/report_type}/stream" method="GET" savePath="/response" >
                <!-- <SSLConfiguration allowUntrustedServerCertificate="true" /> -->
                <BearerAuthentication token="${/bearer_token}" />
                <QueryParameter name="fields" value="${/fields}" />
                <QueryParameter name="limit" value="${/events_per_poll}" />
                <QueryParameter name="since" value="${/bookmark}" />
            </CallEndpoint>

            <If condition="/response/status_code = 200">
                <!-- Handle a succesful response. -->
                <Set path="/events" value="${/response/body/data}" />
                <Set path="/events_count" value="${count(/events)}" />
                <Set path="/fetch_counter" value="${/fetch_counter + 1}" />

                <Log type="INFO" message="[ObserveIT]: ${/events_count} events for were fetched for '${/report_type}'." />

                <!-- If there were any events, post them and update the risingValue timer to the latest one. -->
                <If condition="${/events_count} > 0">
                    <Log type="INFO" message="[ObserveIT]: Posting fetched events..." />
                    <PostEvents path="/events" source="${/identifier}" />

                    <!-- Update the risingValue for next run. -->
                    <Set path="/last_index" value="${/events_count - 1}"/>
                    <ParseDate pattern="${/time_format}" timeZone="${/time_zone}" date="${/events[${/last_index}]/risingValue}" savePath="/last_risingValue" />
                    <FormatDate pattern="${/time_format}" timeZone="${/time_zone}" time="${/last_risingValue}" savePath="/bookmark" />
                    <ParseDate pattern="${/time_format}" timeZone="${/time_zone}" date="${/bookmark}" savePath="/bookmark" />

                    <Log type="INFO" message="[ObserveIT]: 'risingValue' time for '${/report_type}' updated to: ${/bookmark}" />
                </If>

                <Log type="INFO" message="[ObserveIT]: Done fetch period, total time in milliseconds is: ${time() - /start_time}" />

                <If condition="${/events_per_poll} > ${/events_count}">
                    <Log type="INFO" message="[ObserveIT]: Connecter is in sync with ObserveIT server, reseting fetch counter and going to sleep for ${/sleep_time_in_seconds} seconds..." />
                    <Set path="/fetch_counter" value="1" />
                    <Sleep duration="${/sleep_time}" />
                </If>
            </If>
            <ElseIf condition="/response/status_code = 401">
                <!-- If the bearer token has expired fetch a new one.  -->
                <Log type="INFO" message="[ObserveIT]: Bearer token expired, fetching new token..." />

                <!-- Get Bearer Token. -->
                <CallEndpoint url="${/hostname}/v2/apis/auth/oauth/token" method="POST" savePath="/response" >
                    <!-- <SSLConfiguration allowUntrustedServerCertificate="true" /> -->
                    <UrlEncodedFormRequestBody>
                        <Parameter name="grant_type" value="client_credentials" />
                        <Parameter name="client_id" value="${/client_id}" />
                        <Parameter name="client_secret" value="${/client_secret}" />
                        <Parameter name="scope" value="*" />
                    </UrlEncodedFormRequestBody>
                </CallEndpoint>

                <!-- Handle errors. -->
                <If condition="/response/status_code != 200">
                    <If condition="/response/status_code = 400">
                        <Log type="ERROR" message="[ObserveIT]: Abort at get token, reason: ${/response/body/_status/message}" />
                        <Abort reason="${/response}" />
                    </If>
                    <If condition="/response/status_code = 401">
                        <Log type="ERROR" message="[ObserveIT]: Abort at get token, reason: Authentication error!" />
                        <Abort reason="${/response}" />
                    </If>
                    <If condition="/response/status_code = 404">
                        <Log type="ERROR" message="[ObserveIT]: Abort at get token, reason: URL not found!" />
                        <Abort reason="${/response}" />
                    </If>
                    <If condition="/response/status_code = 408">
                        <Log type="ERROR" message="[ObserveIT]: Abort at get token, reason: Timeout error!" />
                        <Abort reason="${/response}" />
                    </If>
                    <If condition="/response/status_code = 500">
                        <Log type="ERROR" message="[ObserveIT]: Abort at get token, reason: Invalid client_id" />
                        <Abort reason="${/response}" />
                    </If>

                    <Log type="ERROR" message="[ObserveIT]: Abort at get token, reason: ${/response}" />
                    <Abort reason="${/response}" />
                </If>

                <Log type="INFO" message="Bearer token received!" />
                <!-- Save the bearer token. -->
                <Set path="/bearer_token" value="${/response/body/access_token}" />
            </ElseIf>
            <Else>
                <!-- If an unexpected error was received from the API -->
                <If condition="/response/status_code = 400">
                    <Log type="ERROR" message="[ObserveIT]: Abort at get ${/report_type} reports, reason: ${/response}/body/_status/message" />
                    <Abort reason="${/response}" />
                </If>
                <If condition="/response/status_code = 404">
                    <Log type="ERROR" message="[ObserveIT]: Abort at get ${/report_type} reports, reason: URL not found!" />
                    <Abort reason="${/response}" />
                </If>

                <Log type="ERROR" message="[ObserveIT]: Abort at get ${/report_type} reports, reason: ${/response}" />
                <Abort reason="${/response}" />
            </Else>
        </While>
	</Actions>

    <Tests>
        <DNSResolutionTest host="${/hostname}" />
        <TCPConnectionTest host="${/hostname}" />
        <HTTPConnectionThroughProxyTest url="${/hostname}" expectedResponseStatus="404" />
    </Tests>
</Workflow>
