<Workflow name="Qmasters CyberInt workflow for QRadar" version="1.0" xmlns="http://qradar.ibm.com/UniversalCloudRESTAPI/Workflow/V2">
    <Parameters>
        <Parameter name="hostName" label="Host Name" required="true" />
        <Parameter name="apiKey" label="API Key" required="true" secret="true" />
        <Parameter name="severity" label="Severity" required="false" />
        <Parameter name="status" label="Status" required="false" default="false" />
        <Parameter name="pageSize" label="Page Size" required="false" default="false" />
        <Parameter name="timeZone" label="Time Zone" required="false" default="UTC" />
    </Parameters>

    <Actions>
        <!-- Clear the log source status before a new workflow run starts -->
        <ClearStatus />

        <!-- Initialize the risingValue filter for the first run. -->
        <Initialize path="/bookmark" value="${time() - 604800000}" />

        <!-- Prepare the start time filter, based on the current bookmark -->
        <FormatDate pattern="yyyy-MM-dd'T'HH:mm:ss" time="${/bookmark}" timeZone="${/timeZone}" savePath="/startTime" />

        <!-- Prepare the end time filter, which is the current time. -->
        <FormatDate pattern="yyyy-MM-dd'T'HH:mm:ss" timeZone="${/timeZone}" savePath="/endTime" />

        <!-- Get Alerts -->
        <CallEndpoint url="${/hostName}/alert/api/v1/alerts" method="POST" savePath="/getAlerts" >
            <RequestHeader name="Cookie" value="access_token=${/apiKey}; Path=/;" />
            <RequestBody type="application/json" encoding="UTF-8">
                {
                    "page": 1,
                    "size": ${/pageSize},
                    "include_csv_attachments_as_json_content": true,
                    "filters":
                        {
                            "status":
                                [
                                    ${/status}
                                ],
                            "severity":
                                [
                                    ${/severity}
                                ],
                            "modification_date":
                                {
                                    "from": "${/startTime}",
                                    "to": "${/endTime}"
                                }
                        }
                }
            </RequestBody>
        </CallEndpoint>

        <!-- Handle Errors -->
        <If condition="/getAlerts/status_code != 200">
            <If condition="/getAlerts/status_code = 403" >
                <Abort reason="The user or team account does not have access to the endpoint/feature/resource." />
                <Log type="ERROR" message="The user or team account does not have access to the endpoint/feature/resource."/>
            </If>
            <If condition="/getAlerts/status_code = 401" >
                <Abort reason="Invalid token or token expired." />
                <Log type="ERROR" message="Invalid Cyberint API token or token expired."/>
            </If>

            <If condition="/getAlerts/status_code = 422" >
                <Abort reason="Bad input parameter. The response body is a plaintext message with more information." />
                <Log type="ERROR" message="Bad input parameter. The response body is a plaintext message with more information."/>
            </If>

            <If condition="/getAlerts/status_code >= 500" >
                <Abort reason="Cyberint API is not available" />
                <Log type="ERROR" message="Cyberint API is not available"/>
            </If>

            <Abort reason="Cyberint abort reason:  ${/getAlerts}" />
            <Log type="ERROR" message="Cyberint abort reason:  ${/getAlerts}"/>
        </If>

        <!-- Post Events, if any -->
            <If condition="count(/getAlerts/body/alerts) > 0">
                <PostEvents path="/getAlerts/body/alerts" source="${/hostName}" />

                <!-- Update the bookmark -->
                <ParseDate pattern="yyyy-MM-dd'T'HH:mm:ss" timeZone="${/timeZone}" date="${max(/getAlerts/body/alerts/modification_date)}" savePath="/lastAlertsTime" />
                <Set path="/bookmark" value="${/lastAlertsTime + 1000}" />
            </If>
            <Else>
                <Set path="/heartBeatLog" value="The connection to the Cyberint API was successfully established; however, there are no new alerts available for retrieval at this moment. The last alert received was at: ${/lastAlert} (UTC)." />
                <PostEvent path="/heartBeatLog" source="${/hostName}" />
            </Else>
    </Actions>
    <Tests>
        <DNSResolutionTest host="${/hostName}" />
        <TCPConnectionTest host="${/hostName}" />
        <SSLHandshakeTest host="${/hostName}" />
        <HTTPConnectionThroughProxyTest url="${/hostName}" expectedResponseStatus="404" />
    </Tests>
</Workflow>
